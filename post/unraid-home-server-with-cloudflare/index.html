<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <meta name="generator" content="Hugo 0.82.0" />
  <link rel="canonical" href="https://www.nadeau.tv/post/unraid-home-server-with-cloudflare/">

  

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">

  <link rel="stylesheet" href="https://www.nadeau.tv/css/prism.css" media="none" onload="this.media='all';">

  
  
  <link rel="stylesheet" type="text/css" href="https://www.nadeau.tv/css/styles.css">

  

  <style id="inverter" media="none">
    .intro-and-nav, .main-and-footer { filter: invert(100%) }
    * { background-color: inherit }
    img:not([src*=".svg"]), .colors, iframe, .demo-container { filter: invert(100%) }
  </style>

  
  
  <title>Secure home server with Unraid and Cloudflare | Christopher Nadeau</title>
</head>

  <body>
    <a href="#main">skip to content</a>
    <svg style="display: none">
  <symbol id="bookmark" viewBox="0 0 40 50">
   <g transform="translate(2266 3206.2)">
    <path style="stroke:currentColor;stroke-width:3.2637;fill:none" d="m-2262.2-3203.4-.2331 42.195 16.319-16.318 16.318 16.318.2331-42.428z"/>
   </g>
  </symbol>

  <symbol id="w3c" viewBox="0 0 127.09899 67.763">
   <text font-size="83" style="font-size:83px;font-family:Trebuchet;letter-spacing:-12;fill-opacity:0" letter-spacing="-12" y="67.609352" x="-26.782778">W3C</text>
   <text font-size="83" style="font-size:83px;font-weight:bold;font-family:Trebuchet;fill-opacity:0" y="67.609352" x="153.21722" font-weight="bold">SVG</text>
   <path style="fill:currentColor;image-rendering:optimizeQuality;shape-rendering:geometricPrecision" d="m33.695.377 12.062 41.016 12.067-41.016h8.731l-19.968 67.386h-.831l-12.48-41.759-12.479 41.759h-.832l-19.965-67.386h8.736l12.061 41.016 8.154-27.618-3.993-13.397h8.737z"/>
   <path style="fill:currentColor;image-rendering:optimizeQuality;shape-rendering:geometricPrecision" d="m91.355 46.132c0 6.104-1.624 11.234-4.862 15.394-3.248 4.158-7.45 6.237-12.607 6.237-3.882 0-7.263-1.238-10.148-3.702-2.885-2.47-5.02-5.812-6.406-10.022l6.82-2.829c1.001 2.552 2.317 4.562 3.953 6.028 1.636 1.469 3.56 2.207 5.781 2.207 2.329 0 4.3-1.306 5.909-3.911 1.609-2.606 2.411-5.738 2.411-9.401 0-4.049-.861-7.179-2.582-9.399-1.995-2.604-5.129-3.912-9.397-3.912h-3.327v-3.991l11.646-20.133h-14.062l-3.911 6.655h-2.493v-14.976h32.441v4.075l-12.31 21.217c4.324 1.385 7.596 3.911 9.815 7.571 2.22 3.659 3.329 7.953 3.329 12.892z"/>
   <path style="fill:currentColor;image-rendering:optimizeQuality;shape-rendering:geometricPrecision" d="m125.21 0 1.414 8.6-5.008 9.583s-1.924-4.064-5.117-6.314c-2.693-1.899-4.447-2.309-7.186-1.746-3.527.73-7.516 4.938-9.258 10.13-2.084 6.21-2.104 9.218-2.178 11.978-.115 4.428.58 7.043.58 7.043s-3.04-5.626-3.011-13.866c.018-5.882.947-11.218 3.666-16.479 2.404-4.627 5.954-7.404 9.114-7.728 3.264-.343 5.848 1.229 7.841 2.938 2.089 1.788 4.213 5.698 4.213 5.698l4.94-9.837z"/>
   <path style="fill:currentColor;image-rendering:optimizeQuality;shape-rendering:geometricPrecision" d="m125.82 48.674s-2.208 3.957-3.589 5.48c-1.379 1.524-3.849 4.209-6.896 5.555-3.049 1.343-4.646 1.598-7.661 1.306-3.01-.29-5.807-2.032-6.786-2.764-.979-.722-3.486-2.864-4.897-4.854-1.42-2-3.634-5.995-3.634-5.995s1.233 4.001 2.007 5.699c.442.977 1.81 3.965 3.749 6.572 1.805 2.425 5.315 6.604 10.652 7.545 5.336.945 9.002-1.449 9.907-2.031.907-.578 2.819-2.178 4.032-3.475 1.264-1.351 2.459-3.079 3.116-4.108.487-.758 1.276-2.286 1.276-2.286l-1.276-6.644z"/>
  </symbol>

  <symbol id="tag" viewBox="0 0 177.16535 177.16535">
    <g transform="translate(0 -875.2)">
     <path style="fill-rule:evenodd;stroke-width:0;fill:currentColor" d="m159.9 894.3-68.79 8.5872-75.42 77.336 61.931 60.397 75.429-76.565 6.8495-69.755zm-31.412 31.835a10.813 10.813 0 0 1 1.8443 2.247 10.813 10.813 0 0 1 -3.5174 14.872l-.0445.0275a10.813 10.813 0 0 1 -14.86 -3.5714 10.813 10.813 0 0 1 3.5563 -14.863 10.813 10.813 0 0 1 13.022 1.2884z"/>
    </g>
  </symbol>

  <symbol id="balloon" viewBox="0 0 141.73228 177.16535">
   <g transform="translate(0 -875.2)">
    <g>
     <path style="fill:currentColor" d="m68.156 882.83-.88753 1.4269c-4.9564 7.9666-6.3764 17.321-5.6731 37.378.36584 10.437 1.1246 23.51 1.6874 29.062.38895 3.8372 3.8278 32.454 4.6105 38.459 4.6694-.24176 9.2946.2879 14.377 1.481 1.2359-3.2937 5.2496-13.088 8.886-21.623 6.249-14.668 8.4128-21.264 10.253-31.252 1.2464-6.7626 1.6341-12.156 1.4204-19.764-.36325-12.93-2.1234-19.487-6.9377-25.843-2.0833-2.7507-6.9865-7.6112-7.9127-7.8436-.79716-.20019-6.6946-1.0922-6.7755-1.0248-.02213.0182-5.0006-.41858-7.5248-.22808l-2.149-.22808h-3.3738z"/>
     <path style="fill:currentColor" d="m61.915 883.28-3.2484.4497c-1.7863.24724-3.5182.53481-3.8494.63994-2.4751.33811-4.7267.86957-6.7777 1.5696-.28598 0-1.0254.20146-2.3695.58589-5.0418 1.4418-6.6374 2.2604-8.2567 4.2364-6.281 7.6657-11.457 18.43-12.932 26.891-1.4667 8.4111.71353 22.583 5.0764 32.996 3.8064 9.0852 13.569 25.149 22.801 37.517 1.3741 1.841 2.1708 2.9286 2.4712 3.5792 3.5437-1.1699 6.8496-1.9336 10.082-2.3263-1.3569-5.7831-4.6968-21.86-6.8361-33.002-.92884-4.8368-2.4692-14.322-3.2452-19.991-.68557-5.0083-.77707-6.9534-.74159-15.791.04316-10.803.41822-16.162 1.5026-21.503 1.4593-5.9026 3.3494-11.077 6.3247-15.852z"/>
     <path style="fill:currentColor" d="m94.499 885.78c-.10214-.0109-.13691 0-.0907.0409.16033.13489 1.329 1.0675 2.5976 2.0723 6.7003 5.307 11.273 14.568 12.658 25.638.52519 4.1949.24765 14.361-.5059 18.523-2.4775 13.684-9.7807 32.345-20.944 53.519l-3.0559 5.7971c2.8082.76579 5.7915 1.727 8.9926 2.8441 11.562-11.691 18.349-19.678 24.129-28.394 7.8992-11.913 11.132-20.234 12.24-31.518.98442-10.02-1.5579-20.876-6.7799-28.959-.2758-.4269-.57803-.86856-.89617-1.3166-3.247-6.13-9.752-12.053-21.264-16.131-2.3687-.86369-6.3657-2.0433-7.0802-2.1166z"/>
     <path style="fill:currentColor" d="m32.52 892.22c-.20090-.13016-1.4606.81389-3.9132 2.7457-11.486 9.0476-17.632 24.186-16.078 39.61.79699 7.9138 2.4066 13.505 5.9184 20.562 5.8577 11.77 14.749 23.219 30.087 38.74.05838.059.12188.1244.18052.1838 1.3166-.5556 2.5965-1.0618 3.8429-1.5199-.66408-.32448-1.4608-1.3297-3.8116-4.4602-5.0951-6.785-8.7512-11.962-13.051-18.486-5.1379-7.7948-5.0097-7.5894-8.0586-13.054-6.2097-11.13-8.2674-17.725-8.6014-27.563-.21552-6.3494.13041-9.2733 1.775-14.987 2.1832-7.5849 3.9273-10.986 9.2693-18.07 1.7839-2.3656 2.6418-3.57 2.4409-3.7003z"/>
     <path style="fill:currentColor" d="m69.133 992.37c-6.2405.0309-12.635.76718-19.554 2.5706 4.6956 4.7759 9.935 10.258 12.05 12.625l4.1272 4.6202h11.493l3.964-4.4516c2.0962-2.3541 7.4804-7.9845 12.201-12.768-8.378-1.4975-16.207-2.6353-24.281-2.5955z"/>
     <rect style="stroke-width:0;fill:currentColor" ry="2.0328" height="27.746" width="22.766" y="1017.7" x="60.201"/>
    </g>
   </g>
  </symbol>

  <symbol id="info" viewBox="0 0 41.667 41.667">
   <g transform="translate(-37.035 -1004.6)">
    <path style="stroke-linejoin:round;stroke:currentColor;stroke-linecap:round;stroke-width:3.728;fill:none" d="m76.25 1030.2a18.968 18.968 0 0 1 -23.037 13.709 18.968 18.968 0 0 1 -13.738 -23.019 18.968 18.968 0 0 1 23.001 -13.768 18.968 18.968 0 0 1 13.798 22.984"/>
    <g transform="matrix(1.1146 0 0 1.1146 -26.276 -124.92)">
     <path style="stroke:currentColor;stroke-linecap:round;stroke-width:3.728;fill:none" d="m75.491 1039.5v-8.7472"/>
     <path style="stroke-width:0;fill:currentColor" transform="scale(-1)" d="m-73.193-1024.5a2.3719 2.3719 0 0 1 -2.8807 1.7142 2.3719 2.3719 0 0 1 -1.718 -2.8785 2.3719 2.3719 0 0 1 2.8763 -1.7217 2.3719 2.3719 0 0 1 1.7254 2.8741"/>
    </g>
   </g>
  </symbol>

  <symbol id="warning" viewBox="0 0 48.430474 41.646302">
    <g transform="translate(-1.1273 -1010.2)">
     <path style="stroke-linejoin:round;stroke:currentColor;stroke-linecap:round;stroke-width:4.151;fill:none" d="m25.343 1012.3-22.14 37.496h44.28z"/>
     <path style="stroke:currentColor;stroke-linecap:round;stroke-width:4.1512;fill:none" d="m25.54 1027.7v8.7472"/>
     <path style="stroke-width:0;fill:currentColor" d="m27.839 1042.8a2.3719 2.3719 0 0 1 -2.8807 1.7143 2.3719 2.3719 0 0 1 -1.718 -2.8785 2.3719 2.3719 0 0 1 2.8763 -1.7217 2.3719 2.3719 0 0 1 1.7254 2.8741"/>
    </g>
  </symbol>

  <symbol id="menu" viewBox="0 0 50 50">
     <rect style="stroke-width:0;fill:currentColor" height="10" width="50" y="0" x="0"/>
     <rect style="stroke-width:0;fill:currentColor" height="10" width="50" y="20" x="0"/>
     <rect style="stroke-width:0;fill:currentColor" height="10" width="50" y="40" x="0"/>
   </symbol>

   <symbol id="link" viewBox="0 0 50 50">
    <g transform="translate(0 -1002.4)">
     <g transform="matrix(.095670 0 0 .095670 2.3233 1004.9)">
      <g>
       <path style="stroke-width:0;fill:currentColor" d="m452.84 192.9-128.65 128.65c-35.535 35.54-93.108 35.54-128.65 0l-42.881-42.886 42.881-42.876 42.884 42.876c11.845 11.822 31.064 11.846 42.886 0l128.64-128.64c11.816-11.831 11.816-31.066 0-42.9l-42.881-42.881c-11.822-11.814-31.064-11.814-42.887 0l-45.928 45.936c-21.292-12.531-45.491-17.905-69.449-16.291l72.501-72.526c35.535-35.521 93.136-35.521 128.64 0l42.886 42.881c35.535 35.523 35.535 93.141-.001 128.66zm-254.28 168.51-45.903 45.9c-11.845 11.846-31.064 11.817-42.881 0l-42.884-42.881c-11.845-11.821-11.845-31.041 0-42.886l128.65-128.65c11.819-11.814 31.069-11.814 42.884 0l42.886 42.886 42.876-42.886-42.876-42.881c-35.54-35.521-93.113-35.521-128.65 0l-128.65 128.64c-35.538 35.545-35.538 93.146 0 128.65l42.883 42.882c35.51 35.54 93.11 35.54 128.65 0l72.496-72.499c-23.956 1.597-48.092-3.784-69.474-16.283z"/>
      </g>
     </g>
    </g>
  </symbol>

  <symbol id="doc" viewBox="0 0 35 45">
   <g transform="translate(-147.53 -539.83)">
    <path style="stroke:currentColor;stroke-width:2.4501;fill:none" d="m149.38 542.67v39.194h31.354v-39.194z"/>
    <g style="stroke-width:25" transform="matrix(.098003 0 0 .098003 133.69 525.96)">
     <path d="m220 252.36h200" style="stroke:currentColor;stroke-width:25;fill:none"/>
     <path style="stroke:currentColor;stroke-width:25;fill:none" d="m220 409.95h200"/>
     <path d="m220 488.74h200" style="stroke:currentColor;stroke-width:25;fill:none"/>
     <path d="m220 331.15h200" style="stroke:currentColor;stroke-width:25;fill:none"/>
    </g>
   </g>
 </symbol>

 <symbol id="tick" viewBox="0 0 177.16535 177.16535">
  <g transform="translate(0 -875.2)">
   <rect style="stroke-width:0;fill:currentColor" transform="rotate(30)" height="155" width="40" y="702.99" x="556.82"/>
   <rect style="stroke-width:0;fill:currentColor" transform="rotate(30)" height="40" width="90.404" y="817.99" x="506.42"/>
  </g>
 </symbol>
</svg>

    <div class="wrapper">
      <header class="intro-and-nav" role="banner">
  <div>
    <div class="intro">
      <a
        class="logo"
        href="https://www.nadeau.tv/"
        aria-label="Christopher Nadeau home page"
      >
        <img src="https://www.nadeau.tv/images/logo.svg" alt="">
      </a>
      <p class="library-desc">
        
      </p>
    </div>
    <nav id="patterns-nav" class="patterns" role="navigation">
  <h2 class="vh">Main navigation</h2>
  <button id="menu-button" aria-expanded="false">
    <svg viewBox="0 0 50 50" aria-hidden="true" focusable="false">
      <use xlink:href="#menu"></use>
    </svg>
    Menu
  </button>
  
  <ul id="patterns-list">
  
    <li class="pattern">
      
      
      
      
      <a href="/post" aria-current="page">
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use xlink:href="#bookmark"></use>
        </svg>
        <span class="text">Blog</span>
      </a>
    </li>
  
    <li class="pattern">
      
      
      
      
      <a href="/tags/" >
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use xlink:href="#bookmark"></use>
        </svg>
        <span class="text">Tags</span>
      </a>
    </li>
  
    <li class="pattern">
      
      
      
      
      <a href="/about/" >
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use xlink:href="#bookmark"></use>
        </svg>
        <span class="text">About</span>
      </a>
    </li>
  
    <li class="pattern">
      
      
      
      
      <a href="/index.xml" >
        <svg class="bookmark-icon" aria-hidden="true" focusable="false" viewBox="0 0 40 50">
          <use xlink:href="#bookmark"></use>
        </svg>
        <span class="text">RSS</span>
      </a>
    </li>
  
  </ul>
</nav>
  </div>
</header>

      <div class="main-and-footer">
        <div>
          
  <main id="main">
    <h1>
      <svg class="bookmark-icon" aria-hidden="true" viewBox="0 0 40 50" focusable="false">
        <use xlink:href="#bookmark"></use>
      </svg>
      Secure home server with Unraid and Cloudflare
    </h1>

    <div class="date">
      
      
      <strong>Publish date: </strong>Aug 8, 2020
      
        
      
    </div>

    
      <div class="tags">
        <strong>Tags: </strong>
        <ul aria-label="tags">
          
            <li>
              <svg class="tag-icon" aria-hidden="true" viewBox="0 0 177.16535 177.16535" focusable="false">
                <use xlink:href="#tag"></use>
              </svg>
              
              <a href="https://www.nadeau.tv/tags/tech/">Tech</a>
            </li>
          
        </ul>
      </div>
    
    
    
      

  <nav class="toc" aria-labelledby="toc-heading">
    <h2 id="toc-heading">Table of contents</h2>
    <ol>
      
        <li>
          
          
          
          
          <a href="#the-problem">
            The Problem
          </a>
        </li>
      
        <li>
          
          
          
          
          <a href="#defining-the-goals">
            Defining the goals
          </a>
        </li>
      
        <li>
          
          
          
          
          <a href="#putting-together-a-plan">
            Putting together a plan
          </a>
        </li>
      
        <li>
          
          
          
          
          <a href="#setup-your-domain-with-cloudflare">
            Setup: Your domain with Cloudflare
          </a>
        </li>
      
        <li>
          
          
          
          
          <a href="#setup-cloudflare-access">
            Setup: Cloudflare Access
          </a>
        </li>
      
        <li>
          
          
          
          
          <a href="#setup-argo-tunnel">
            Setup: Argo Tunnel
          </a>
        </li>
      
        <li>
          
          
          
          
          <a href="#setup-traefik">
            Setup: Traefik
          </a>
        </li>
      
        <li>
          
          
          
          
          <a href="#setup-use-friendly-names-on-the-local-network">
            Setup: Use friendly names on the local network
          </a>
        </li>
      
        <li>
          
          
          
          
          <a href="#limitations">
            Limitations
          </a>
        </li>
      
    </ol>
  </nav>


    

    <p>I built a home server earlier this year to serve as a NAS and home media center. I&rsquo;m trying to make a more concerted effort to take control over my own data and rely less on cloud services.</p>
<p>I chose <a href="https://unraid.net/">Unraid</a> as the underlying operating system. If you&rsquo;re building a home server, I really recommend checking it out. Out of the options I tried, Unraid was by far the easiest to get up and running with.</p>
<h2 id="the-problem">The Problem</h2>
<p>The entire purpose behind building my home server was so I could take control over my data and rely less on cloud services. But this presents a problem: if I wanted to access my data from outside my home network, then I had to open up access to the server from the wider internet.</p>
<p>This isn&rsquo;t a problem per-se, but I was really not into the idea of having the server open to the internet. What if there was a 0-day with Unraid or an app that I was using? I&rsquo;m planning on putting a lot of data on this server, some of which is going to be highly personal, and I really really don&rsquo;t want to have to worry about security issues that might lead to data leaks.</p>
<p>There are a number of ways you could solve this problem. One of the more common ways is to use a VPN to restrict access to the server. But I thought that would be clunky. Imagine I wanted to hop on to my <a href="https://github.com/the-paperless-project/paperless">Paperless</a> site to fetch a document on my phone &ndash; how annoying would it be to have to connect to a VPN first.</p>
<h2 id="defining-the-goals">Defining the goals</h2>
<ol>
<li>
<p>I wanted to access services I run on my home server with an easy to remember domain name. For example, <code>https://paperless.example.com/</code> would load Paperless.</p>
</li>
<li>
<p>I wanted a way to totally lock-down access to the running services until I was authorised. E.g. say Paperless' login process had a 0-day vulnerbility that allowed anyone to bypass the login, I wanted to be immune to that sort of bug. I wanted any anonymous connection to be simply impossible.</p>
</li>
<li>
<p>I wanted an easy way to bypass these restrictions on my local network.</p>
</li>
<li>
<p>I wanted to make sure I could still log in to the server via SSH remotely, just in case.</p>
</li>
</ol>
<h2 id="putting-together-a-plan">Putting together a plan</h2>
<h3 id="domain-mapping">Domain Mapping</h3>
<p>The first thing on the list is <em>domain mapping</em>. I want a certain hostname to map directly to a running service on Unraid. For example, <code>paperless.example.com</code> needs to connect to Paperless which is running on port 8555 in a docker container.</p>
<p>I run all of my services as docker containers, and one of the easiest ways to get this all set up is to run a reverse proxy with Traefik: Connection -&gt; Traefik -&gt; Docker -&gt; Backend App.</p>
<h3 id="access-control">Access Control</h3>
<p>Goals 2-4 are really all a variation on the same theme &ndash; access control. For this I chose to use Cloudflare Access along with Cloudflare Argo Tunnel.</p>
<ul>
<li>Cloudflare Access: Is basically a &ldquo;login screen&rdquo; that sits between the wider internet and your backend service. So a user goes to app.example.com and Cloudflare Access will make the user authenticate before they will allow requests through to the backend. If the user doesn&rsquo;t or can&rsquo;t authenticate, then requests simply don&rsquo;t get through.</li>
<li>Argo Tunnel with <code>cloudflared</code>: This is a daemon that runs on the server that establishes a persistent connection <em>from</em> the Unraid server <em>to</em> Cloudflare. All traffic between Cloudflare and Unraid flows through this tunnel. Since the tunnel is established from within the home network, it means we don&rsquo;t have to allow <em>inbound</em> connections, we don&rsquo;t have to set up port forwarding, we don&rsquo;t have to think about firewalls, and we don&rsquo;t have to think about dynamic DNS.</li>
</ul>
<p>Combining these two things means:</p>
<ul>
<li>There simply is no exposed network to the internet. There is nothing to &ldquo;hack&rdquo; because we just don&rsquo;t allow incoming connections.</li>
<li>We lock-down access to specific people we want to give access to via Access policies. E.g. I have mine locked down to just my email address and my partners email address.</li>
</ul>
<p>(Worth saying that the single vulnerability point here is Cloudflare. We are placing a lot of trust in Cloudflare&rsquo;s systems being secure.)</p>
<p><img src="/post-files/unraid-cloudflare/unraid-argo-tunnel.png" alt="Argo Tunnel to Unraid diagram"></p>
<aside aria-label="note" class="note">
  <div>
    <svg class="sign" aria-hidden="true" viewBox="0 0 41.667306 41.66729" focusable="false">
      <use xlink:href="#info"></use>
    </svg>
    
At the time of this writing, Cloudflare Access is free for up to 5 user accounts, and then is $5/user/month after that.

  </div>
</aside>

<h2 id="setup-your-domain-with-cloudflare">Setup: Your domain with Cloudflare</h2>
<ul>
<li>Sign up at Cloudflare</li>
<li>Register a domain name. My registrar of choice is <a href="https://porkbun.com/">Porkbun</a>.</li>
<li>Follow your registrars instructions to set Cloudflare nameservers.</li>
<li>Add your domain to Cloudflare.</li>
</ul>
<h2 id="setup-cloudflare-access">Setup: Cloudflare Access</h2>
<p>Once that&rsquo;s done, you need to go and configure Cloudflare Access. Click the &ldquo;Access&rdquo; icon and enable Cloudflare Access on your account. You can configure any kind of login methods, but I actually just keep the default &ldquo;One-time Pin&rdquo; method which sends you a code via email that you have to enter.</p>
<h3 id="access-policies-to-create">Access policies to create</h3>
<p>Create initial access policies for these three domains that we are going to set up now:</p>
<ul>
<li><code>unraid.YOUR_HOST_NAME.com</code> &ndash; this will load the unraid web UI.</li>
<li><code>ssh.YOUR_HOST_NAME.com</code> &ndash; The <code>ssh</code> subdomain will be used for SSH access.</li>
<li><code>traefik.YOUR_HOST_NAME.com</code> &ndash; The <code>traefik</code> subdomain will be used as a dashboard to show you traefik info.</li>
</ul>
<p>Here&rsquo;s an example policy that allows based on an email address:</p>
<p><img src="/post-files/unraid-cloudflare/example-access-policy.png" alt="Cloudflare Access policy"></p>
<h2 id="setup-argo-tunnel">Setup: Argo Tunnel</h2>
<p>Next, we should set up Argo Tunnel. To do this you will need to SSH into your Unraid box.</p>
<h3 id="save-files-and-binaries">Save files and binaries</h3>
<p>There are two binaries we need to install on Unraid:</p>
<ul>
<li><a href="https://github.com/cloudflare/cloudflared"><code>cloudflared</code></a> &ndash; The daemon that establishes the tunnel with Cloudflare</li>
<li><a href="https://github.com/ochinchina/supervisord"><code>supervisord</code></a> &ndash; A process manager that we can use to make sure cloudflared is always running and gets restarted in the event of a crash. The linked project here is a golang implementation of supervisord because I wanted a single-binary to copy, rather than the original version written in Python.</li>
</ul>
<p>I&rsquo;ve taken the liberty of creating a tarball of everything you need here: <a href="https://nadeau.tv/post-files/unraid-cloudflare/custom.tgz">https://nadeau.tv/post-files/unraid-cloudflare/custom.tgz</a></p>
<p>You need to install these files to <code>/boot/config/custom</code>.</p>
<aside aria-label="warning" class="note warning">
  <div>
    <svg class="sign" aria-hidden="true" viewBox="0 0 48.430474 41.646302" focusable="false">
      <use xlink:href="#warning"></use>
    </svg>
    
You can't install it to a user mount because we need it to run even if the Unraid array is offline, and you can't install it anywhere else on the filesystem because the rest of the filesystem is reset after each reboot.

  </div>
</aside>

<p>So here&rsquo;s an example SSH session:</p>
<pre><code>cd /boot/config
curl -L https://nadeau.tv/post-files/unraid-cloudflare/custom.tgz -o custom.tgz
tar zxvf custom.tgz
</code></pre>
<p>Which will extract to:</p>
<div class="file-tree">
  <ul>
<li>/boot/config/custom
<ul>
<li>/cloudflared
<ul>
<li>cert.pem</li>
<li>cloudflared</li>
</ul>
</li>
<li>/supervisord
<ul>
<li>supervisord</li>
<li>supervisord.conf</li>
</ul>
</li>
</ul>
</li>
</ul>

</div>

<h3 id="modify-the-hostnames-in-config">Modify the hostnames in config</h3>
<p>You need to edit the supervisord.conf file to change the hostnames. In the config, change <code>YOUR_HOST_NAME.com</code> to your real domain name.</p>
<p>There are two tunnels we&rsquo;re setting up with two different host names:</p>
<ul>
<li><code>unraid.YOUR_HOST_NAME.com</code> &ndash; the <code>unraid</code> sub-domain will be used for HTTP(S) connections (that will go through to Traefik, which is described below)</li>
<li><code>ssh.YOUR_HOST_NAME.com</code> &ndash; the <code>ssh</code> sub-domain will be used for SSH, so you can always SSH into the box remotely.</li>
</ul>
<pre><code>cd /boot/config/supervisord
nano supervisord.conf
</code></pre>
<p>When done, press <code>Ctrl+O</code> to write the file, followed by <code>Ctrl+X</code> to exit the nano editor.</p>
<h3 id="initiate-the-domain-with-cloudflare">Initiate the domain with Cloudflare</h3>
<p>Still connected via SSH, execute:</p>
<pre><code>cd /boot/config/cloudflared
cloudflared tunnel login
</code></pre>
<ul>
<li>The command will output a URL you need to copy+paste into your browser</li>
<li>Log in using your Cloudflare account</li>
<li>And then click on the domain you added to Cloudflare before.</li>
</ul>
<p>After you finish, you should see something like this in your terminal:</p>
<pre><code>You have successfully logged in.
If you wish to copy your credentials to a server, they have been saved to:
/root/.cloudflared/cert.pem
</code></pre>
<p>Move the filename dislpayed here to <code>/boot/config/custom/cloudflared/cert.pem</code>. For example:</p>
<pre><code>mv /root/.cloudflared/cert.pem /boot/config/custom/cloudflared/cert.pem
</code></pre>
<h3 id="test-the-tunnel">Test the tunnel</h3>
<p>It&rsquo;s a good idea to test out the tunnel now. Let&rsquo;s test out the SSH tunnel by starting it in the foreground:</p>
<pre><code>cd /boot/config/cloudflared
cloudflared --origincert cert.pem --no-tls-verify --hostname ssh.YOUR_HOST_NAME.com --url ssh://localhost:22
</code></pre>
<p>You&rsquo;ll see a bunch of output but after a few seconds, you <em>should</em> be able to open a SSH connection <em>through</em> <code>ssh.YOUR_HOST_NAME.com</code> (e.g. open another terminal window and try it out). You should have already created a policy for the <code>ssh</code> sub-domain in a previous step; so when you try to SSH through this host now, you <em>should</em> have to log-in via the Cloudflare Access web UI before the connection is allowed.</p>
<h3 id="install-boot-script">Install boot script</h3>
<p>Now you need to edit <code>/boot/config/go</code> which is a Bash script that Unraid executes automatically whenever the server boots up. You&rsquo;ll need to <em>add</em> a few lines to this script to make sure supervisord runs at boot.</p>
<pre><code>cd /boot/config
nano go
</code></pre>
<p>And then at the <em>bottom of the file</em> add these lines:</p>
<pre><code>cp -R /boot/config/custom /root
chmod +x /root/custom/cloudflared/cloudflared
chmod +x /root/custom/supervisord/supervisord

/root/custom/supervisord/supervisord -c /root/custom/supervisord/supervisord.conf -d
</code></pre>
<p>When done, press <code>Ctrl+O</code> to write the file, followed by <code>Ctrl+X</code> to exit the nano editor.</p>
<h3 id="reboot">Reboot</h3>
<p>Reboot your Unraid server now so the tunnel starts. Test out the SSH tunnel again just to make sure it&rsquo;s running.</p>
<h2 id="setup-traefik">Setup: Traefik</h2>
<p>Go ahead and install the <em>Traefik</em> community app.</p>
<aside aria-label="note" class="note">
  <div>
    <svg class="sign" aria-hidden="true" viewBox="0 0 41.667306 41.66729" focusable="false">
      <use xlink:href="#info"></use>
    </svg>
    
I suggest you change the repository value to "traefik:1.7.26". When I installed this app, it was defaulted to "traefik:latest" which ended up breaking my install a couple days later when a major new version was released with breaking changes.

  </div>
</aside>

<p><img src="/post-files/unraid-cloudflare/traefik-app.png" alt="Traefik app"></p>
<p>Here are the options I suggest you set. You&rsquo;ll note that I&rsquo;ve <em>removed</em> some of the default options by clicking the &ldquo;Remove&rdquo; button.</p>
<p><img src="/post-files/unraid-cloudflare/traefik-options.png" alt="Traefik options"></p>
<p>The important change here is to make sure the 8080 is <code>80</code>, and 443 port is <code>443</code>. In other words, we want default HTTP(S) traffic going to Traefik.</p>
<h3 id="edit-config">Edit config</h3>
<p>Connect via SSH again, we&rsquo;re going to edit <code>/mnt/user/appdata/traefik/traefik.toml</code></p>
<pre><code>nano /mnt/user/appdata/traefik/traefik.toml
</code></pre>
<p>Make it look like this:</p>
<pre><code>debug = true
logLevel = &quot;debug&quot;
InsecureSkipVerify = false
defaultEntryPoints = [&quot;https&quot;, &quot;http&quot;]

[entryPoints]
  [entryPoints.traefik]
  address = &quot;:8082&quot;
  [entryPoints.http]
  address = &quot;:8080&quot;
  [entryPoints.https]
  address = &quot;:443&quot;
    [entryPoints.https.tls]

[docker]
endpoint = &quot;unix:///var/run/docker.sock&quot;
domain = &quot;${DOMAINNAME}&quot;
watch = true
exposedbydefault = false

[api]
  entryPoint = &quot;traefik&quot;
  dashboard = true

[file]

[frontends]
  [frontends.unraid]
  passHostHeader = true
  backend = &quot;unraid&quot;
    [frontends.unraid.routes.r1]
    rule = &quot;Host:unraid.YOUR_HOST_NAME.com&quot;

  [frontends.traefik]
  passHostHeader = true
  backend = &quot;traefik&quot;
    [frontends.traefik.routes.r1]
    rule = &quot;Host:traefik.YOUR_HOST_NAME.com&quot;

[backends]
  [backends.unraid]
    [backends.unraid.servers.s1]
    weight = 1
    url = &quot;http://10.0.0.24:2095&quot; # CHANGEME - the IP and port of unraid web control panel

  [backends.traefik]
    [backends.traefik.servers.s1]
    weight = 1
    url = &quot;http://127.0.0.1:8082&quot;
</code></pre>
<ul>
<li>Change the YOUR_HOST_NAME.com to your own domain (on two lines).</li>
<li>And change the CHANGEME line containing the ip/port of your unraid server.</li>
</ul>
<p>At this point you should be able to load <code>https://unraid.YOUR_HOST_NAME.com/</code> in your browser to load the Unraid web UI.</p>
<h3 id="configure-apps">Configure apps</h3>
<p>For every docker app you want to expose, you need to add <em>labels</em> with the following keys:</p>
<ul>
<li><code>traefik.enable</code> with the value <code>true</code>. This tells Traefik that you want to enable routing to this app.</li>
<li><code>traefik.backend</code> with the value of the <em>Name</em> of the docker container. E.g. <code>deluge</code>, <code>plex</code>, <code>paperless</code> etc. Whatever is in the <em>Name</em> field at the top of the page.</li>
<li><code>traefik.frontend.rule</code> should be in the form of <code>Host:whatever.YOUR_HOST_NAME.com</code> - the name you choose here can be whatever you want, it doesn&rsquo;t have to be named after the app. E.g. <code>Host:plex.YOUR_HOST_NAME.com</code> is valid but so is <code>Host:superfreak.YOUR_HOST_NAME.com</code></li>
<li><code>traefik.port</code> the port <em>inside the container</em> to forward requests to. Note that this is the port for the service running INSIDE the container, <em>not</em> the mapped port.</li>
<li><code>traefik.docker.network</code> should almost always be <code>bridge</code></li>
</ul>
<p>So to do this, you go into a docker app in Unraid, and click &ldquo;Add another Path, Port, Variable, Label or Device&rdquo;.</p>
<p><img src="/post-files/unraid-cloudflare/docker-setup-1.png" alt="Add a label link"></p>
<p>Switch &ldquo;Config Type&rdquo; to &ldquo;Label&rdquo;, and then in the &ldquo;Key&rdquo; field input the label key listed above and in the &ldquo;Value&rdquo; field input the value as described above.</p>
<p><img src="/post-files/unraid-cloudflare/docker-add-label.png" alt="Add a label"></p>
<p>For example, I have Plex running on my box that looks like this:</p>
<p><img src="/post-files/unraid-cloudflare/traefik-plex-config.png" alt="Add a label"></p>
<h3 id="configure-dns-for-each-app">Configure DNS for each app</h3>
<p>Back in Cloudflare, go to the DNS tab on your domain. If the Argo Tunnel is running (it should be by now, if you&rsquo;ve rebooted your server), you&rsquo;ll see a special record for the <code>unraid</code> subdomain:</p>
<p><img src="/post-files/unraid-cloudflare/cf-unraid-record.png" alt="Cloudflare argo tunnel domain"></p>
<p>For each app you configured in the previous step, we need to create a CNAME record to this <code>unraid</code> name. For example, if you have a &ldquo;plex&rdquo; app and want &ldquo;plex.YOUR_HOST_NAME.com&rdquo; and you prepared the labels on the docker container, you&rsquo;d now add a new CNAME record for that:</p>
<p><img src="/post-files/unraid-cloudflare/cf-add-cname.png" alt="Cloudflare add CNAME"></p>
<p>Then go back to the &ldquo;Access&rdquo; tab and add a policy for this app like you did before.</p>
<aside aria-label="warning" class="note warning">
  <div>
    <svg class="sign" aria-hidden="true" viewBox="0 0 48.430474 41.646302" focusable="false">
      <use xlink:href="#warning"></use>
    </svg>
    
It's important you add a policy now, otherwise the app will be world-accessible.

  </div>
</aside>

<h3 id="traefik-dashboard">Traefik Dashboard</h3>
<p>If you want the Traefik dashboard to work, you should create a CNAME for <code>traefik.YOUR_HOST_NAME.com</code> (and an accompanying policy) now. It&rsquo;s not totally necessary, but it can be useful to see the status and health of the services running.</p>
<p><img src="/post-files/unraid-cloudflare/traefik-health.png" alt="Traefik heath"></p>
<h3 id="try-it-out">Try it out</h3>
<p>At this point you should have:</p>
<div class="ticks">
  <ul>
<li>Argo tunnel running on the unraid host</li>
<li>Traefik running</li>
<li>Your app(s) docker containers labelled with the <code>traefik.*</code> keys</li>
<li>Cloudflare CNAMEs created for your app(s)</li>
<li>Cloudflare Access policies created for your app(s)</li>
</ul>

</div>

<p>If it&rsquo;s all working as it should, you should be able to go to <code>https://yourapp.YOUR_HOST_NAME.com</code> in your browser, and use the app.</p>
<h2 id="setup-use-friendly-names-on-the-local-network">Setup: Use friendly names on the local network</h2>
<p>So this is all great when we&rsquo;re away from home. But when we are home, we don&rsquo;t want to proxy all traffic through Cloudflare because it&rsquo;s going to introduce unecessary internet traffic. And for me at least, I didn&rsquo;t want to enforce the same level of access control when using these apps from home.</p>
<p>You can obviously just continue to use the services via their IP/port combos like you might usually, but now that we have Traefik installed, it&rsquo;s simple to add a secondary hostname so we can get friendly names we can use at home.</p>
<h3 id="note-your-private-ip-for-the-unraid-server">Note your private IP for the unraid server</h3>
<p>You need to note down the private IP address of the unraid server within your home network. For example, mine is <code>10.0.0.24</code>.</p>
<p>You should configure your router to always assign this IP address to the Unraid server. How you do this will depend on your router, but it&rsquo;s usually under DCHP settings.</p>
<h3 id="set-up-dns">Set up DNS</h3>
<p>Back in Cloudflare, go to the DNS tab once more, and add <em>two</em> new <code>A</code> records:</p>
<ul>
<li><code>local</code></li>
<li>and <code>*.local</code></li>
</ul>
<p>Both of these records should point to the private IP address of your unraid server (e.g. mine is <code>10.0.0.24</code>).</p>
<p><img src="/post-files/unraid-cloudflare/cf-local-recs.png" alt="Cloudflare Local records"></p>
<h3 id="set-up-traefik-routes">Set up Traefik routes</h3>
<p>Go back to each docker app you added labels for. Remember the <code>traefik.frontend.rule</code> with the <code>Host:</code> value? This can actually take a comma-separated list of rules. So what we can do is add a second host, one for the local domain.</p>
<p>For example:</p>
<ul>
<li>Before: <code>Host:plex.YOUR_HOST_NAME.com</code></li>
<li>Change to: <code>Host:plex.YOUR_HOST_NAME.com,plex.local.YOUR_HOST_NAME.com</code></li>
</ul>
<p>This means Traefik will know how to respond to both of those host names.</p>
<p>The main host name has DNS that points to Cloudflare and gets processed by Cloudflare (with Access and through the tunnel); then this new local host name has DNS that is your private IP address that will only work from within your home network. Anyone else who tries the local hostname won&rsquo;t be on your network and so their requests won&rsquo;t go anywhere.</p>
<h2 id="limitations">Limitations</h2>
<p>The major limitation to this method is that it only works for HTTP(S) traffic from a browser, or for SSH. That means other protocols won&rsquo;t work, and any app that has a dedicated mobile app most likely won&rsquo;t handle the Cloudflare Access auth flow (e.g. the actual Plex app on iOS).</p>
<p>Solving some of these limitations in other ways is the subject of another blog post!</p>

  </main>
  <div id="disqus-container">
  
</div>


          <footer role="contentinfo">
  <div>
    <label for="themer">
      dark theme: <input type="checkbox" id="themer" class="vh">
      <span aria-hidden="true"></span>
    </label>
  </div>
  
</footer>

        </div>
      </div>
    </div>
    <script src="https://www.nadeau.tv/js/prism.js"></script>



<script src="https://www.nadeau.tv/js/dom-scripts.js"></script>



<script src="/js/search.7aef046a0cc8b0c532f1d20087b920459bc868c936bb48a6ae221eceefca2d07.js"></script>

<link rel="stylesheet" href="/css/search.fe0cd54a21628574bff49d721c827d1bb165ab56b0f22dd55ae78addbe61c309.css"></link>


    
    <script type="text/javascript">
var clicky_site_ids = clicky_site_ids || [];
clicky_site_ids.push(101151077);
(function() {
  var s = document.createElement('script');
  s.type = 'text/javascript';
  s.async = true;
  s.src = '//static.getclicky.com/js';
  ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
})();
</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101151077ns.gif" /></p></noscript>

  </body>
</html>
