<!doctype html>
<html lang="en-gb">
  <head>
    <title>pt-online-schema-change error &#34;Error creating new table ... duplicate key&#34; // Chris&#39; Blog</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.92.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Christopher Nadeau" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://www.nadeau.io/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="pt-online-schema-change error &#34;Error creating new table ... duplicate key&#34;"/>
<meta name="twitter:description" content="pt-online-schema-change is a tool in the Percona Toolkit which allows you to make large table alters without locking the database.
Newer versions of MySQL have Online DDL which reduce the need for this tool. But if you&rsquo;re like us, pt-online-schema-change is still very valuable because we use Galera. Running a DDL query on a Galera cluster blocks the entire cluster (even other databases in the same cluster).
I&rsquo;ve successfully used pt-online-schema-change in the past with great success."/>

    <meta property="og:title" content="pt-online-schema-change error &#34;Error creating new table ... duplicate key&#34;" />
<meta property="og:description" content="pt-online-schema-change is a tool in the Percona Toolkit which allows you to make large table alters without locking the database.
Newer versions of MySQL have Online DDL which reduce the need for this tool. But if you&rsquo;re like us, pt-online-schema-change is still very valuable because we use Galera. Running a DDL query on a Galera cluster blocks the entire cluster (even other databases in the same cluster).
I&rsquo;ve successfully used pt-online-schema-change in the past with great success." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.nadeau.io/post/pt-online-schema-change-error-error-creating-new-table-duplicate-key/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2016-06-16T16:11:04+00:00" />
<meta property="article:modified_time" content="2016-06-16T16:11:04+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://www.nadeau.io/"><img class="app-header-avatar" src="/avatar.png" alt="Christopher Nadeau" /></a>
      <h1>Chris&#39; Blog</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/post">Blog</a>
             • 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
             • 
          
          <a class="app-header-menu-item" href="/about/">About</a>
             • 
          
          <a class="app-header-menu-item" href="/index.xml">RSS</a>
      </nav>
      <p> </p>
      <div class="app-header-social">
        
          <a href="https://github.com/chroder" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/chroder" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">pt-online-schema-change error &#34;Error creating new table ... duplicate key&#34;</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jun 16, 2016
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://www.nadeau.io/tags/mysql/">MySQL</a>
              <a class="tag" href="https://www.nadeau.io/tags/devops/">DevOps</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p><code>pt-online-schema-change</code> is a tool in the <a href="https://www.percona.com/doc/percona-toolkit/2.2/index.html">Percona Toolkit</a> which allows you to make large table alters without locking the database.</p>
<p>Newer versions of MySQL have <a href="https://dev.mysql.com/doc/refman/5.6/en/innodb-create-index-overview.html">Online DDL</a> which reduce the need for this tool. But if you&rsquo;re like us, <code>pt-online-schema-change</code> is still very valuable because we use Galera. Running a DDL query on a Galera cluster blocks the entire cluster (even other databases in the same cluster).</p>
<p>I&rsquo;ve successfully used <code>pt-online-schema-change</code> in the past with great success. This week I tried to use it again to perform some expensive queries and I ran into an error message like this:</p>
<pre><code>Error creating new table: DBD::mysql::db do failed: Can't write; duplicate key in table '_child_new'
</code></pre>
<p>A bit of Google-fu and I discovered it was linked to <a href="https://bugs.launchpad.net/percona-toolkit/+bug/1498128">this</a> bug.</p>
<p>The bug is marked as fixed in version 2.2.17 &ndash; <strong>but it is not</strong>. If you need a truly fixed version, jump to the end of this post: <a href="#thefix">The Fix</a>.</p>
<h3 id="briefly-how-the-tool-works">Briefly: How the tool works</h3>
<p>To understand the bug, you need to understand a bit about how the tool actually works.</p>
<p><code>pt-online-schema-change</code> creates a brand new table, applies your ALTER query on the new table (which is &ldquo;fast&rdquo; because it&rsquo;s empty), and then proceeds to copy records from the old table to the new table in chunks. It installs triggers on the old table to handle deletes and updates. Basically, you&rsquo;re syncing the two tables together.</p>
<p>When the new table is synced with the old table, the tool switches them: The old table is dropped and the new table is renamed to the real table name.</p>
<p><strong>The Problem: Foreign Keys</strong></p>
<p>The problem is foreign keys. The FK needs to exist simultaneously in the old table and the new table, but FK names must be <em>unique</em> across the entire database.</p>
<p>To work around this, <code>pt-online-schema-change</code> prefixes the FK&rsquo;s with an underscore in the new table. Example:</p>
<ul>
<li>Original FK: <code>MY_FK</code></li>
<li>New FK: <code>_MY_FK</code></li>
</ul>
<p>Then when the tables are swapped, you&rsquo;re still left with that prefixed FK in the production table.</p>
<p>Run the tool a second time? Well, once upon a time, you&rsquo;d just end up with a double-prefixed FK. So the second time, you&rsquo;d have <code>__MY_FK</code>. The third time, you&rsquo;d have <code>___MY_FK</code>&hellip; etc.</p>
<p>The issue is that the maximum length of a FK is 64 characters. Imagine a schema changing many times over the course of a few years, you can easily breach this limit.</p>
<p>So Percona patched the tool so it would detect if there was a FK with an underscore, and switch to <em>stripping</em> the underscore. In other words, they wanted it to alternate: <code>MY_FK</code> to <code>_MY_FK</code>, then back to <code>MY_FK</code> again if you ran it again.</p>
<p><strong>The Bug</strong></p>
<p>The bug is that the original patch checked for <em>any</em> FK with underscores. Meaning, if you had <code>_MY_FK</code> and <code>MY_OTHER_FK</code>, it would detect the underscore on the first one and assume that it needed to strip FKs. Of course, there is no underscore on the second, so it would be a no-op.</p>
<ul>
<li>Originals: <code>_MY_FK</code>, <code>MY_OTHER_FK</code></li>
<li>New FKs: <code>MY_FK</code>, <code>MY_OTHER_FK</code></li>
</ul>
<p>As you see, a new table would attempt to create a FK with a name that already exists. <em>And that is the error.</em></p>
<h2 id="the-fix">The Fix</h2>
<p>Peter Dolberg, the op of the <a href="https://bugs.launchpad.net/percona-toolkit/+bug/1498128">bug report</a>, supplied a suggested patch. Despite the bug being marked as fixed in 2.2.17, it is not. What I ended up doing is copying the source, patching it myself, and then I just used the patched version:</p>
<ol>
<li>
<p>Install percona-toolkit the usual way.</p>
</li>
<li>
<p>Copy the source of the <code>pt-online-schema-change</code> tool.</p>
</li>
</ol>
<pre tabindex="0"><code>cp `which pt-online-schema-change` my-pt-osc
</code></pre><ol start="3">
<li>Patch it according to Peter&rsquo;s instructions. I took the liberty of creating a patch file:</li>
</ol>
<script src="https://gist.github.com/chroder/18474448f7a08e0deb7de01055294010.js"></script>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
