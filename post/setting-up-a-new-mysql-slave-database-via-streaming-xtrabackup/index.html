<!doctype html>
<html lang="en-gb">
  <head>
    <title>Setting up a new MySQL slave database via steaming xtrabackup // Chris&#39; Blog</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.92.2" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Christopher Nadeau" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://www.nadeau.io/css/main.min.4a7ec8660f9a44b08c4da97c5f2e31b1192df1d4d0322e65c0dbbc6ecb1b863f.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Setting up a new MySQL slave database via steaming xtrabackup"/>
<meta name="twitter:description" content="The goal today is to build a new MySQL slave database off an existing database. We&rsquo;ll use Percona&rsquo;s xtrabackup to stream a hot backup over the wire to a new machine, while keeping the existing server online.
Prep Install MySQL on New Server
Install MySQL in the way you normally would (e.g., apt-get etc).
The only very important thing you need to do is edit my.cnf and set a server-id for the server."/>

    <meta property="og:title" content="Setting up a new MySQL slave database via steaming xtrabackup" />
<meta property="og:description" content="The goal today is to build a new MySQL slave database off an existing database. We&rsquo;ll use Percona&rsquo;s xtrabackup to stream a hot backup over the wire to a new machine, while keeping the existing server online.
Prep Install MySQL on New Server
Install MySQL in the way you normally would (e.g., apt-get etc).
The only very important thing you need to do is edit my.cnf and set a server-id for the server." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.nadeau.io/post/setting-up-a-new-mysql-slave-database-via-streaming-xtrabackup/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2016-01-27T18:16:45+00:00" />
<meta property="article:modified_time" content="2016-01-27T18:16:45+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://www.nadeau.io/"><img class="app-header-avatar" src="/avatar.png" alt="Christopher Nadeau" /></a>
      <h1>Chris&#39; Blog</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/post">Blog</a>
             • 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
             • 
          
          <a class="app-header-menu-item" href="/about/">About</a>
             • 
          
          <a class="app-header-menu-item" href="/index.xml">RSS</a>
      </nav>
      <p> </p>
      <div class="app-header-social">
        
          <a href="https://github.com/chroder" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/chroder" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Setting up a new MySQL slave database via steaming xtrabackup</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jan 27, 2016
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          5 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://www.nadeau.io/tags/devops/">DevOps</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>The goal today is to build a new MySQL slave database off an existing database. We&rsquo;ll use Percona&rsquo;s <a href="https://www.percona.com/doc/percona-xtrabackup">xtrabackup</a> to <em>stream</em> a hot backup over the wire to a new machine, while keeping the existing server online.</p>
<h2 id="prep">Prep</h2>
<p><strong>Install MySQL on New Server</strong></p>
<p>Install MySQL in the way you normally would (e.g., <code>apt-get</code> etc).</p>
<p>The only very important thing you need to do is edit <code>my.cnf</code> and set a <a href="http://dev.mysql.com/doc/refman/5.7/en/replication-options.html#option_mysqld_server-id"><code>server-id</code></a> for the server. This can be any integer. I tend to use the current date and time just because it&rsquo;s generally pretty unique (like <code>201601271730</code>).</p>
<p><strong>Install xtrabackup on both servers</strong></p>
<p>Both servers need to have <a href="https://www.percona.com/doc/percona-xtrabackup">xtrabackup</a>. If you use Debian, Ubuntu or CentOS, you&rsquo;re best off just using <a href="https://www.percona.com/doc/percona-xtrabackup/2.3/installation.html#installing-from-binaries">Percona&rsquo;s repositories</a>.</p>
<p>For example, here&rsquo;s how I installed it on Ubuntu:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-txt" data-lang="txt">$ wget -O /tmp/percona-repos.deb https://repo.percona.com/apt/percona-release_0.1-3.$(lsb_release -sc)_all.deb
$ sudo dpkg -i /tmp/percona-repos.deb
$ sudo apt-get update
$ sudo apt-get install percona-xtrabackup
</code></pre></div><p><strong>Create holding directory on new server</strong></p>
<p>We&rsquo;ll shortly stream data from the existing server to the new server. You need a directory on the new server, so create it now:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-txt" data-lang="txt">root@new# mkdir /root/mysql-data
</code></pre></div><blockquote>
<p>Note: For the rest of this post, I&rsquo;ll use <code>new</code> to refer to the new slave you&rsquo;re setting up, and <code>old</code> to refer to the old, existing server.</p>
</blockquote>
<p><strong>Increase maximum number of open file descriptors</strong></p>
<p>You <em>may</em> run into issues with too many files being open at once. This can happen if you have <em>many</em> databases, and/or if you use MySQL with one-file-per-table.</p>
<p>In your console, before you run any commands (on both old/new servers), it&rsquo;s smart to raise the limit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-txt" data-lang="txt">root@example# ulimit -n 1024000
</code></pre></div><blockquote>
<p>Note that this does NOT persist the change. It&rsquo;ll reset back to the system default as soon as you disconnect.</p>
</blockquote>
<h2 id="stream-a-hot-backup-no-downtime">Stream a hot backup (no downtime)</h2>
<p>Now we start the stream from the old server to the new server. The general command looks something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-txt" data-lang="txt">root@old# innobackupex \
    --no-lock \
    --user=root \
    --password=XXX \
    --stream=xbstream ./ \
    | ssh user@target &#34;xbstream -x -C /root/mysql-data/&#34;
</code></pre></div><p><code>--no-lock</code> prevents locking the database tables. If you need your existing server to stay online and still accept writes, you need to use this option. Note however that this is ONLY safe if ALL of your tables are InnoDB. If you are using other storage engines, you have no choice but to lock the tables as the copy happens.</p>
<blockquote>
<p>Note: Do not issue DDL queries (including creating new databases or tables)  when you use <code>--no-lock</code>.</p>
</blockquote>
<p><code>--stream=xbstream</code> tells innobackupex to compress and stream the data, and then we pipe it through <code>ssh</code> to the remote server. Since it&rsquo;s compressed, this is also ideal if you&rsquo;re configuring a slave over the WAN.</p>
<p><strong>Two other special cases</strong></p>
<ul>
<li>If the <code>old</code> server is itself a slave, you should use <code>--safe-slave-backup</code> option. This stops the slave SQL thread until the backup completes.</li>
<li>If you want your <code>new</code> server to be a slave of the same master as <code>old</code>, use the <code>--slave-info</code> option. This will output the position info for the master. More on that in a bit.</li>
</ul>
<h2 id="process-the-backup">Process the backup</h2>
<p>After the stream finishes, you&rsquo;ll be left with a bunch of data in <code>/root/mysql-data</code>. This data isn&rsquo;t ready to use yet, we need to apply the binlogs that innobackupex was copying as it went:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-txt" data-lang="txt">root@new# cd /root/mysql-data
root@new# innobackupex --apply-log .
</code></pre></div><p>You also need to find the position info (we&rsquo;ll use it in a moment). Write down the contents of this file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-txt" data-lang="txt">root@new# cat /root/mysql-data/xtrabackup_binlog_pos_innodb
</code></pre></div><h2 id="move-data-files-into-place">Move data files into place</h2>
<p>On the new server still, we now need to move the data files into the places where the MySQL server actually expects to find them. I typically move the old/default dirs into tmp just in case I need them for some reason.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-txt" data-lang="txt">root@new# mv /var/lib/mysql /tmp/old-mysql-lib
root@new# mv /var/log/mysql /tmp/old-mysq-log
root@new# mv /root/mysql-data /var/lib/mysql
root@new# mkdir /var/log/mysql
root@new# chown -R mysql:mysql /var/lib/mysql /var/log/mysql
</code></pre></div><p>Now you can start the MySQL server again (e.g., <code>service mysql start</code>). It should come back online without a problem.</p>
<p><strong>Credentials</strong></p>
<p>Note that we have literally just copied the whole database from the old to the new server. That&rsquo;s including MySQL&rsquo;s internal tables that define things like credentials.</p>
<p>In other words, any users and passwords you might have configured when you installed MySQL on the new server are no gone. They are all replaced with the users that existed on the &lsquo;old&rsquo; server.</p>
<p><i class="fa fa-exclamation-circle"></i> On Debian/Ubuntu, the system inserts a special <code>debian-sys-maint</code> user for maintanance related stuff. So you will need to manualy modify <code>/etc/mysql/debian.cnf</code> and copy the password from the &lsquo;old&rsquo; server. Alternatively, you can just reset the user password instead after the server is started (next).</p>
<h2 id="start-the-slave">Start the slave</h2>
<p>At this point, your <code>new</code> server is set up and it has the data up until the point where the innobackupex command finished. The next step is making this a real slave, so it can begin to replicate off of a real master.</p>
<p>Connect to the local mysql server on the new server (e.g., <code>mysql -uroot ...</code>). And we&rsquo;ll change the master and start the slave:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-sql" data-lang="sql">CHANGE MASTER <span style="color:#ff79c6">TO</span>
    MASTER_HOST<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;&lt;MASTER IP ADDRESS&gt;&#39;</span>,
    MASTER_USER<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;&lt;REPL USER&gt;&#39;</span>,
    MASTER_PASSWORD<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;&lt;REPL PASSWORD&gt;&#39;</span>,
    MASTER_LOG_FILE<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;&lt;BIN FILE FROM xtrabackup_binlog_pos_innodb&gt;&#39;</span>,
    MASTER_LOG_POS<span style="color:#ff79c6">=&lt;</span><span style="color:#ff79c6">POSITION</span> <span style="color:#ff79c6">FROM</span> xtrabackup_binlog_pos_innodb<span style="color:#ff79c6">&gt;</span>;
</code></pre></div><p>Fill in the details for your master host, and be sure to double check the bin log file and position that you got before (from the <code>cat /root/mysql-data/xtrabackup_binlog_pos_innodb</code> we ran above).</p>
<p>Then start the salve, wait a few seconds, and check the status to make sure it&rsquo;s running:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2"><code class="language-SQL" data-lang="SQL"><span style="color:#ff79c6">START</span> SLAVE;
<span style="color:#ff79c6">SHOW</span> SLAVE STATUS\<span style="color:#ff79c6">G</span>
</code></pre></div><h2 id="all-done">All Done</h2>
<p>You should have a fully functional slave now :-)</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
