<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">

        
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">

        <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet"> 

        <title>Setting up a new MySQL slave database via steaming xtrabackup</title>

        <link rel="stylesheet" href="/css/stylesheet.css">
    </head>
    <body>
      <div class="container-fluid">
        <nav class="navbar navbar-expand-md navbar-light">

          
          <span class="navbar-brand mb-0 h1"></span>

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle Navigation" name="button">
            <span class="navbar-toggler-icon"></span>
          </button>

          <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
            <div class="navbar-nav">
              <a class="nav-item nav-link " href="/">Home</a>
              <a class="nav-item nav-link" href="https://github.com/chroder" target="_blank">GitHub</a>
              
              <a class="nav-item nav-link " href="/about/">About</a>
            </div>
          </div>
        </nav>

        <section id="page-title">
          <h1><a href="/">Christopher Nadeau</a></h1>
          <span id="author-name">
            <h6><a href="/about/"></a></h6>
          </span>
        </section>


<div class="blog-post">
  <h1>Setting up a new MySQL slave database via steaming xtrabackup</h1>
  <div class="blog-post-subheader">
    <time>27 Jan 2016</time>
  </div>
  <div class="blog-post-content">
    

<p>The goal today is to build a new MySQL slave database off an existing database. We&rsquo;ll use Percona&rsquo;s <a href="https://www.percona.com/doc/percona-xtrabackup">xtrabackup</a> to <em>stream</em> a hot backup over the wire to a new machine, while keeping the existing server online.</p>

<h2 id="prep">Prep</h2>

<p><strong>Install MySQL on New Server</strong></p>

<p>Install MySQL in the way you normally would (e.g., <code>apt-get</code> etc).</p>

<p>The only very important thing you need to do is edit <code>my.cnf</code> and set a <a href="http://dev.mysql.com/doc/refman/5.7/en/replication-options.html#option_mysqld_server-id"><code>server-id</code></a> for the server. This can be any integer. I tend to use the current date and time just because it&rsquo;s generally pretty unique (like <code>201601271730</code>).</p>

<p><strong>Install xtrabackup on both servers</strong></p>

<p>Both servers need to have <a href="https://www.percona.com/doc/percona-xtrabackup">xtrabackup</a>. If you use Debian, Ubuntu or CentOS, you&rsquo;re best off just using <a href="https://www.percona.com/doc/percona-xtrabackup/2.3/installation.html#installing-from-binaries">Percona&rsquo;s repositories</a>.</p>

<p>For example, here&rsquo;s how I installed it on Ubuntu:</p>

<pre><code class="language-txt">$ wget -O /tmp/percona-repos.deb https://repo.percona.com/apt/percona-release_0.1-3.$(lsb_release -sc)_all.deb
$ sudo dpkg -i /tmp/percona-repos.deb
$ sudo apt-get update
$ sudo apt-get install percona-xtrabackup
</code></pre>

<p><strong>Create holding directory on new server</strong></p>

<p>We&rsquo;ll shortly stream data from the existing server to the new server. You need a directory on the new server, so create it now:</p>

<pre><code class="language-txt">root@new# mkdir /root/mysql-data
</code></pre>

<blockquote>
<p>Note: For the rest of this post, I&rsquo;ll use <code>new</code> to refer to the new slave you&rsquo;re setting up, and <code>old</code> to refer to the old, existing server.</p>
</blockquote>

<p><strong>Increase maximum number of open file descriptors</strong></p>

<p>You <em>may</em> run into issues with too many files being open at once. This can happen if you have <em>many</em> databases, and/or if you use MySQL with one-file-per-table.</p>

<p>In your console, before you run any commands (on both old/new servers), it&rsquo;s smart to raise the limit:</p>

<pre><code class="language-txt">root@example# ulimit -n 1024000
</code></pre>

<blockquote>
<p>Note that this does NOT persist the change. It&rsquo;ll reset back to the system default as soon as you disconnect.</p>
</blockquote>

<h2 id="stream-a-hot-backup-no-downtime">Stream a hot backup (no downtime)</h2>

<p>Now we start the stream from the old server to the new server. The general command looks something like this:</p>

<pre><code class="language-txt">root@old# innobackupex \
    --no-lock \
    --user=root \
    --password=XXX \
    --stream=xbstream ./ \
    | ssh user@target &quot;xbstream -x -C /root/mysql-data/&quot;
</code></pre>

<p><code>--no-lock</code> prevents locking the database tables. If you need your existing server to stay online and still accept writes, you need to use this option. Note however that this is ONLY safe if ALL of your tables are InnoDB. If you are using other storage engines, you have no choice but to lock the tables as the copy happens.</p>

<blockquote>
<p>Note: Do not issue DDL queries (including creating new databases or tables)  when you use <code>--no-lock</code>.</p>
</blockquote>

<p><code>--stream=xbstream</code> tells innobackupex to compress and stream the data, and then we pipe it through <code>ssh</code> to the remote server. Since it&rsquo;s compressed, this is also ideal if you&rsquo;re configuring a slave over the WAN.</p>

<p><strong>Two other special cases</strong></p>

<ul>
<li>If the <code>old</code> server is itself a slave, you should use <code>--safe-slave-backup</code> option. This stops the slave SQL thread until the backup completes.</li>
<li>If you want your <code>new</code> server to be a slave of the same master as <code>old</code>, use the <code>--slave-info</code> option. This will output the position info for the master. More on that in a bit.</li>
</ul>

<h2 id="process-the-backup">Process the backup</h2>

<p>After the stream finishes, you&rsquo;ll be left with a bunch of data in <code>/root/mysql-data</code>. This data isn&rsquo;t ready to use yet, we need to apply the binlogs that innobackupex was copying as it went:</p>

<pre><code class="language-txt">root@new# cd /root/mysql-data
root@new# innobackupex --apply-log .
</code></pre>

<p>You also need to find the position info (we&rsquo;ll use it in a moment). Write down the contents of this file:</p>

<pre><code class="language-txt">root@new# cat /root/mysql-data/xtrabackup_binlog_pos_innodb
</code></pre>

<h2 id="move-data-files-into-place">Move data files into place</h2>

<p>On the new server still, we now need to move the data files into the places where the MySQL server actually expects to find them. I typically move the old/default dirs into tmp just in case I need them for some reason.</p>

<pre><code class="language-txt">root@new# mv /var/lib/mysql /tmp/old-mysql-lib
root@new# mv /var/log/mysql /tmp/old-mysq-log
root@new# mv /root/mysql-data /var/lib/mysql
root@new# mkdir /var/log/mysql
root@new# chown -R mysql:mysql /var/lib/mysql /var/log/mysql
</code></pre>

<p>Now you can start the MySQL server again (e.g., <code>service mysql start</code>). It should come back online without a problem.</p>

<p><strong>Credentials</strong></p>

<p>Note that we have literally just copied the whole database from the old to the new server. That&rsquo;s including MySQL&rsquo;s internal tables that define things like credentials.</p>

<p>In other words, any users and passwords you might have configured when you installed MySQL on the new server are no gone. They are all replaced with the users that existed on the &lsquo;old&rsquo; server.</p>

<p><i class="fa fa-exclamation-circle"></i> On Debian/Ubuntu, the system inserts a special <code>debian-sys-maint</code> user for maintanance related stuff. So you will need to manualy modify <code>/etc/mysql/debian.cnf</code> and copy the password from the &lsquo;old&rsquo; server. Alternatively, you can just reset the user password instead after the server is started (next).</p>

<h2 id="start-the-slave">Start the slave</h2>

<p>At this point, your <code>new</code> server is set up and it has the data up until the point where the innobackupex command finished. The next step is making this a real slave, so it can begin to replicate off of a real master.</p>

<p>Connect to the local mysql server on the new server (e.g., <code>mysql -uroot ...</code>). And we&rsquo;ll change the master and start the slave:</p>

<pre><code class="language-sql">CHANGE MASTER TO
    MASTER_HOST='&lt;MASTER IP ADDRESS&gt;',
    MASTER_USER='&lt;REPL USER&gt;',
    MASTER_PASSWORD='&lt;REPL PASSWORD&gt;',
    MASTER_LOG_FILE='&lt;BIN FILE FROM xtrabackup_binlog_pos_innodb&gt;',
    MASTER_LOG_POS=&lt;POSITION FROM xtrabackup_binlog_pos_innodb&gt;;
</code></pre>

<p>Fill in the details for your master host, and be sure to double check the bin log file and position that you got before (from the <code>cat /root/mysql-data/xtrabackup_binlog_pos_innodb</code> we ran above).</p>

<p>Then start the salve, wait a few seconds, and check the status to make sure it&rsquo;s running:</p>

<pre><code class="language-SQL">START SLAVE;
SHOW SLAVE STATUS\G
</code></pre>

<h2 id="all-done">All Done</h2>

<p>You should have a fully functional slave now :-)</p>

  </div>
</div>

      <footer>
        <hr>
        <small>
          &copy; 2019 
        </small>
      </footer>
    </div> 

    
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>

    <script type="text/javascript">
    var clicky_site_ids = clicky_site_ids || [];
    clicky_site_ids.push(101151077);
    (function() {
      var s = document.createElement('script');
      s.type = 'text/javascript';
      s.async = true;
      s.src = '//static.getclicky.com/js';
      ( document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0] ).appendChild( s );
    })();
    </script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101151077ns.gif" /></p></noscript>
  </body>
</html>

